<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.didk.dao.ChatSessionDao">

    <select id="selectConversationsByCursor" resultType="com.didk.vo.ChatConversationListItemVO">
        SELECT
        c.id,
        c.type,
        c.target_id,
        c.name,
        c.head_image AS image,
        c.is_pinned,
        c.last_msg_time,
        c.last_msg_content,
        c.last_msg_type,
        c.unread_count
        FROM chat_session c
        WHERE c.user_id = #{userId}

        <if test="sessionName != null and sessionName.trim() != ''">
            AND c.name LIKE CONCAT('%', #{sessionName}, '%')
        </if>

        <if test="cursorTime != null and cursorPinned != null">
            /* 如果最后一条会话被置顶了，那么所有未被置顶的会话都需要查询，同时查询剩下的置顶的会话*/
            /* 如果最后一条会话未被置顶，则查询所有符合时间的未被置顶的会话*/
            AND (
            c.is_pinned &lt; #{cursorPinned}
            OR
            (c.is_pinned = #{cursorPinned} AND c.last_msg_time &lt; #{cursorTime})
            )
        </if>

        ORDER BY c.is_pinned DESC, c.last_msg_time DESC

        LIMIT #{limit}
    </select>

</mapper>