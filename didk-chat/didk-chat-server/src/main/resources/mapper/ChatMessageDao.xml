<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.didk.dao.ChatMessageDao">

    <resultMap type="com.didk.entity.ChatMessageEntity" id="messageMap">
        <result property="id" column="id"/>
        <result property="sendId" column="send_id"/>
        <result property="receiverType" column="receiver_type"/>
        <result property="receiverId" column="receiver_id"/>
        <result property="messageType" column="message_type"/>
        <result property="content" column="content"/>
        <result property="announceId" column="announce_id"/>
        <result property="createDate" column="create_date"/>
    </resultMap>

    <select id="selectFriendMessages" resultType="com.didk.vo.ChatMessageVO">
        select chat_message.*,sys_user.username,sys_user.head_image from chat_message
        join sys_user on chat_message.send_id = sys_user.id
        where ((send_id = #{userId} and receiver_id = #{friendId}) or (send_id = #{friendId} and receiver_id =
        #{userId}))
            and receiver_type = 0
        <if test="lastCreateDate != null and lastCreateDate.trim()!=''">
            and create_date &lt; #{lastCreateDate}

        </if>
        order by create_date desc limit #{limit};
    </select>

    <select id="selectRoomMessages" resultType="com.didk.vo.ChatMessageVO">
        select chat_message.*,sys_user.username,sys_user.head_image from chat_message
        join sys_user on chat_message.send_id = sys_user.id
        where receiver_id = #{roomId}
        and receiver_type = 1
        <if test="sendId != null">
            and send_id = #{sendId}
        </if>
        <if test="lastCreateDate != null and lastCreateDate.trim()!=''">
            and create_date &lt; #{lastCreateDate}
        </if>
        order by create_date desc limit #{limit};
    </select>

    <update id="setAnnounceIdNull" parameterType="java.lang.Long">
        update chat_message set announce_id = null where announce_id = #{announceId}
    </update>

    <update id="setAnnounceIdNullBatch">
        update chat_message set announce_id = null where announce_id in
        <foreach item="id" collection="ids" separator="," close=")" open="(" index="index">
            #{id}
        </foreach>
    </update>


</mapper>